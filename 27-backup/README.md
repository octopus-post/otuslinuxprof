# Less27. Резервное копирование
- [Less27. Резервное копирование](#less27-резервное-копирование)
    - [Цель:](#цель)
    - [Содержание:](#содержание)
    - [Компетенции](#компетенции)
    - [Задание:](#задание)
    - [Формат сдачи:](#формат-сдачи)
    - [Критерии оценки:](#критерии-оценки)
    - [Комментарии к выполнению задания:](#комментарии-к-выполнению-задания)
    - [Links:](#links)

### Цель: 
- использовать политики и методики резерного копирования;
- работать с инструментами rsync, tar, dd и bacula.
- Настроить бэкапы.
  
### Содержание:
- введение и базовые понятия;
- создание резервных копий;
- Bacula;
- Borg;
### Компетенции
Обеспечение стабильности
- организовывать системы резервного копирования

### Задание:
1. Настроить стенд Vagrant с двумя виртуальными машинами: backup_server и client. (Студент самостоятельно настраивает Vagrant)
2. Настроить удаленный бэкап каталога /etc c сервера client при помощи borgbackup. Резервные копии должны соответствовать следующим критериям:
   - директория для резервных копий /var/backup. Это должна быть отдельная точка монтирования. В данном случае для демонстрации размер не принципиален, достаточно будет и 2GB; (Студент самостоятельно настраивает)
   - репозиторий для резервных копий должен быть зашифрован ключом или паролем - на усмотрение студента;
   - имя бэкапа должно содержать информацию о времени снятия бекапа;
   - глубина бекапа должна быть год, хранить можно по последней копии на конец месяца, кроме последних трех. Последние три месяца должны содержать копии на каждый день. Т.е. должна быть правильно настроена политика удаления старых бэкапов;
   - резервная копия снимается каждые 5 минут. Такой частый запуск в целях демонстрации;
   - написан скрипт для снятия резервных копий. Скрипт запускается из соответствующей Cron джобы, либо systemd timer-а - на усмотрение студента;
   - настроено логирование процесса бекапа. Для упрощения можно весь вывод перенаправлять в logger с соответствующим тегом. Если настроите не в syslog, то обязательна ротация логов.


### Формат сдачи: 
Vagrantfile + ansible

### Критерии оценки:
Статус «Принято» ставится при выполнении следующих условий:
1. Сcылка на репозиторий GitHub.
2. Vagrantfile, который будет разворачивать виртуальные машины
3. Настройка виртуальных машин происходит с помощью Ansible.
4. Документация по каждому заданию:
Создайте файл README.md и снабдите его следующей информацией:
- название выполняемого задания;
- текст задания;
- схема сети;
- особенности проектирования и реализации решения, 
- заметки, если считаете, что имеет смысл их зафиксировать в
репозитории.

### Комментарии к выполнению задания:
> _Задание выполнено c использованием Vagrant, libvirt, vagrant box cloud-image/ubuntu-22.04 версия 20240823.0.0_

1. [Vagantfile](./Vagrantfile)
   - создаёт две виртуальные машины в одной подсети: backup, client
   - после создания хостов запускает плейбук
2. [Ansible-playbook](./ansible/provision.yml)
    - устанавливает borg
    - на сервере создаёт пользователя borg, создает файл authorized_keys с открытым ключом
    - на клиент копирует пару ключей 
3. - создан конфиг сервиса /etc/systemd/system/[borg-backup.service](./files/borg-backup.service)
   - создан конфиг таймера /etc/systemd/system/[borg-backup.timer](./files/borg-backup.timer)
4. Список команд и вывод представлен в файле [typescript01](./files/typescript01)

### Links:

- https://habr.com/ru/company/flant/blog/420055/
- https://www.opennet.ru/tips/3180_borg_backup.shtml
- https://borgbackup.readthedocs.io/en/stable/usage/general.html
- https://github.com/alisianoi/borg-systemd
- https://dextervolkman.com/posts/borg_backups
- ---
- [Cкоростная синхронизация миллиарда файлов](https://habr.com/ru/articles/132098/)
- [Сравнение способов резервного копирования](https://habr.com/ru/companies/selectel/articles/226831/)
- 
