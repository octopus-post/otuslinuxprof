---
- name: Set nextcloud maintenance mode ON
  become: true
  ansible.builtin.shell:
    cmd: "sudo -E -u www-data php {{ nextcloud_data_dir }}/occ maintenance:mode --on"

- name: Create dump
#  become: true
  include_tasks:
    file: create_mysql_dump/tasks/create_mysql_dump.yml

- name: Check NC backup dir status
  ansible.builtin.stat:
    path: "{{ nextcloud_backup_dir }}/nextcloud"
  register: reg_nc_backup_status

- name: Check nextcloud dir
  ansible.builtin.debug:
    msg: "{{ reg_nc_backup_status.stat }}"

- name: Archive Nextcloud data directory and config
  become: true
  ansible.builtin.copy:
    src: "{{ nextcloud_data_dir }}"
    dest: "{{ nextcloud_backup_dir }}"
    owner: www-data
    group: www-data
    mode: "0755"
    remote_src: true
  when: not reg_nc_backup_status.stat.exists

- name: Set nextcloud maintenance mode OFF
  become: true
  ansible.builtin.shell:
    cmd: "sudo -E -u www-data php {{ nextcloud_data_dir }}/occ maintenance:mode --off"
