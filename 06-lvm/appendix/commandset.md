# Управление и конфигурирование LVM

Для управления LVM необходим пакет lvm2.

*/usr/sbin/lvm* - основная утилита, все остальные - лишь симлинки на нее.

Основные элементы конфигурации LVM:


| каталог | назначение |
| --- | --- |
| - */etc/lvm/*         | хранилище кэша конфигурации и резервных копий |
| - */etc/lvm/lvm.conf* | основная конфигурация для утилиты lvm
| - *archive/*          | информация за все время
| - *backup/*           | бэкап текущей конфигурации
| - *cache/*            | кэш
| - *proﬁle/*           | готовые (или самописные профили)
**********************************
Создаем physical volume на блочном устройстве:
```bash
[root@otus ~]# pvcreate /dev/sdb
```
Создаем volume group на блочном устройстве:
```bash
[root@otus ~]# vgcreate vg0 /dev/sdb
```
Создаем дополнительный physical volume:
```bash
[root@otus ~]# pvcreate /dev/sdc
```
Расширяем volume group на новый physical volume:
```bash
[root@otus ~]# vgextend vg0 /dev/sdc
```
Вариант создания logical volume размером 10экстентов по 4M:
```bash
[root@otus ~]# lvcreate -l 10 -n home vg0
```
Вариант создания logical volume размером 1 Гб:
```bash
[root@otus ~]# lvcreate -L 1G -n root vg0
```
Создаем logical volume на 100% свободного пространства:
```bash
[root@otus ~]# lvcreate -l 100%FREE -n var vg0
```
Сканирование блочных устройств на предмет наличия LVM:
```bash
[root@otus ~]# vgscan
```
Сделать volume group неактивной:
```bash
[root@otus ~]# vgchange -an
```
Альтернативные команды для просмотра состояний элементов LVM:
```bash
[root@otus ~]# pvs | vgs | lvs
```
*************************************
Тестирование (dry-run) восстановления конфигурации LVM из бэкапа:
```bash
[root@otuslinux ~]# vgcfgrestore VolGroup00 --test -f /etc/lvm/archive/ VolGroup00_00000-2099537038.vg
```
Восстановление конфигурации LVM из бэкапа:
```bash
[root@otuslinux ~]# vgcfgrestore VolGroup00 -f /etc/lvm/archive/VolGroup00_00000-2099537038.vg
```
Далее запускаем lvscan для валидации:
```bash
lvscan
```
*************************************
SNAPSHOTS
===
*Особенности:*
- необходимо наличие свободного места в VG под снапшот в результате при использовании снапшотов мы получаем двойную запись и как следствие - замедление дисковых операций
- удаление снапшота - быстрый процесс
- откат на снапшот - медленный процесс
- снапшот можно монтировать, в том числе в RW режиме
****
Создание снапшота:
```bash
[root@otus ~]# lvcreate -L 500M -s -n test-snap /dev/otus/test
```
Слить (смержить) снапшот с оригинальным LV:
```bash
[root@otus ~]# lvconvert --merge /dev/otus/test-snap
```
Удаление снапшота:
```bash
[root@otus ~]# lvremove /dev/otus/test-snap
```
***************************************
Перенос данных с LVM представляет собой процедуру переноса использующихся физических экстентов
Особенности:
- для перемещения данных в активной системе используется команда pvmove
- pvmove разбивает данные на секции и создает временное зеркало для переноса каждой секции

*Пример:*
Перенос всех данных с физического тома /dev/sdc на другие физические тома в группе:
```bash
pvmove -b /dev/sdc
```
Удалить диск из VG
```bash
pvremove /dev/sdc 
```