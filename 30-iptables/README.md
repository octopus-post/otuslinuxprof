# Less30. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞ - iptables
- [Less30. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞ - iptables](#less30-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è-—Ç—Ä–∞—Ñ–∏–∫–∞---iptables)
    - [–¶–µ–ª—å:](#—Ü–µ–ª—å)
    - [–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:](#—Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ)
    - [–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:](#—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
    - [–ö–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏](#–∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏)
    - [–ó–∞–¥–∞–Ω–∏–µ:](#–∑–∞–¥–∞–Ω–∏–µ)
    - [–§–æ—Ä–º–∞—Ç —Å–¥–∞—á–∏:](#—Ñ–æ—Ä–º–∞—Ç-—Å–¥–∞—á–∏)
    - [–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:](#–∫—Ä–∏—Ç–µ—Ä–∏–∏-–æ—Ü–µ–Ω–∫–∏)
    - [–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∑–∞–¥–∞–Ω–∏—è:](#–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏-–∫-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é-–∑–∞–¥–∞–Ω–∏—è)
      - [1. knocking port](#1-knocking-port)
      - [2. FORWARD](#2-forward)
    - [Links:](#links)

### –¶–µ–ª—å: 
- –ø–æ–Ω–∏–º–∞—Ç—å –ø—É—Ç—å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ø–∞–∫–µ—Ç–æ–≤;
- –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –±–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏;
- –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –Ω–∞–±–æ—Ä—ã –ø—Ä–∞–≤–∏–ª —á–µ—Ä–µ–∑ ipset;
  
### –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:
- –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞ netfilter;
- —Ü–µ–ø–æ—á–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã;
- —Å–∏–Ω—Ç–∞–∫—Å–∏—Å iptables;
- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ IPset
 
### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–µ—Ç–µ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä
### –ö–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏

–†–∞–±–æ—Ç–∞ —Å —Å–µ—Ç–µ–≤–æ–π –ø–æ–¥—Å–∏—Å—Ç–µ–º–æ–π
- –æ–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å —Å–µ—Ç–µ–≤—É—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- 
### –ó–∞–¥–∞–Ω–∏–µ:

–ù–∞–ø–∏—Å–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–∏ iptables.
–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?

- —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å knocking port
- centralRouter –º–æ–∂–µ—Ç –ø–æ–ø–∞—Å—Ç—å –Ω–∞ ssh inetRouter —á–µ—Ä–µ–∑ knock —Å–∫—Ä–∏–ø—Ç (–ø—Ä–∏–º–µ—Ä –≤ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö.)
- –¥–æ–±–∞–≤–∏—Ç—å inetRouter2, –∫–æ—Ç–æ—Ä—ã–π –≤–∏–¥–µ–Ω(–º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç—Å—è (host-only —Ç–∏–ø —Å–µ—Ç–∏ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª–∫–∏)) —Å —Ö–æ—Å—Ç–∞ –∏–ª–∏ —Ñ–æ—Ä–≤–∞—Ä–¥–∏—Ç—Å—è –ø–æ—Ä—Ç —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—Ö–æ—Å—Ç.
- –∑–∞–ø—É—Å—Ç–∏—Ç—å nginx –Ω–∞ centralServer.
- –ø—Ä–æ–±—Ä–æ—Å–∏—Ç—å 80–π –ø–æ—Ä—Ç –Ω–∞ inetRouter2 8080.
- –¥–µ—Ñ–æ–ª—Ç –≤ –∏–Ω–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ inetRouter.

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Ö–æ–¥ –Ω–∞ 80–π –ø–æ—Ä—Ç –±–µ–∑ –º–∞—Å–∫–∞—Ä–∞–¥–∏–Ω–≥–∞*

### –§–æ—Ä–º–∞—Ç —Å–¥–∞—á–∏: 
–§–æ—Ä–º–∞—Ç —Å–¥–∞—á–∏ –î–ó - vagrant + ansible


### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:
–°—Ç–∞—Ç—É—Å "–ü—Ä–∏–Ω—è—Ç–æ" —Å—Ç–∞–≤–∏—Ç—Å—è –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π.

–ó–∞–¥–∞–Ω–∏–µ —Å–æ –∑–≤–µ–∑–¥–æ—á–∫–æ–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ –∂–µ–ª–∞–Ω–∏—é.

### –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∑–∞–¥–∞–Ω–∏—è:
> _–ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º:_
> - Vagrant 2.4.5
> - Virtualbox 7.1.8 r168469
> - vagrant box: bento/ubuntu-22.04
> - Ansible [core 2.18.5]

#### 1. knocking port
*–º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ [port_knocking.md](./appendix/port_knocking.md)*

- —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–µ–º–æ–Ω–∞ [knockd.conf.j2](./vagrant30/ansible/templates/knockd.conf.j2)
- —Ñ–∞–π–ª –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∑–∞–ø—É—Å–∫–∞ –¥–µ–º–æ–Ω–∞ [knockd.j2](./vagrant30/ansible/templates/knockd.j2)
- —É—Å—Ç–∞–Ω–æ–≤–∫–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –¥–µ–º–æ–Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –≤ –ø–ª–µ–π–±—É–∫–µ ansible [provision.yml](./vagrant30/ansible/provision.yml)
- –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –¥–µ–º–æ–Ω–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –∏–∑ iptables —É–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ, —Ä–∞–∑—Ä–µ—à–∞—é—â–µ–µ –Ω–æ–≤—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ –ø–æ—Ä—Ç—É 22:
```bash 
iptables -D INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
```
- –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ inetRouter –¥–µ–º–æ–Ω —Å–ª—É—à–∞–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å enp0s8
- –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ centralRouter –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –Ω–∞ –ø–æ—Ä—Ç—ã 7000, 8000, 9000 
```bash
vagrant@centralRouter:~$ knock 192.168.255.1 7000 8000 9000
```
- –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ inetRouter –¥–µ–º–æ–Ω –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–ª—è —É–∑–ª–∞ 192.168.255.2 –ø–æ—Ä—Ç 22 –Ω–∞ 10 —Å–µ–∫.:
  
```bash
-A INPUT -s 192.168.255.2/32 -p tcp -m tcp --dport 22 -j ACCEPT
```
- –¥–∞–ª–µ–µ –ø—Ä–∞–≤–∏–ª–æ —É–¥–∞–ª—è–µ—Ç—Å—è, –Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —Ä–∞–∑—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –≤ iptables –ø—Ä–∞–≤–∏–ª–∞:
  
```bash
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
``` 

```bash 
# —Å–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª iptables
vagrant@inetRouter:~$ sudo iptables-save
# Generated by iptables-save v1.8.7 on Wed May 21 16:00:21 2025
*filter
:INPUT DROP [32:2388]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [3759:426655]
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A INPUT -s 192.168.255.2/32 -p tcp -m tcp --dport 22 -j ACCEPT
-A FORWARD -i enp0s8 -j ACCEPT
-A FORWARD -o enp0s8 -j ACCEPT
-A FORWARD -i enp0s10 -j ACCEPT
-A FORWARD -o enp0s10 -j ACCEPT
COMMIT
# Completed on Wed May 21 16:00:21 2025
# Generated by iptables-save v1.8.7 on Wed May 21 16:00:21 2025
*nat
:PREROUTING ACCEPT [214:25889]
:INPUT ACCEPT [126:12707]
:OUTPUT ACCEPT [49:6044]
:POSTROUTING ACCEPT [40:5376]
-A POSTROUTING ! -d 192.168.0.0/16 -o enp0s10 -j MASQUERADE
COMMIT
# Completed on Wed May 21 16:00:21 2025
```
#### 2. FORWARD
- –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ centralServer –∑–∞–ø—É—â–µ–Ω nginx
- –Ω–∞ inetRouter2 –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–∞ 80 –¥–æ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (–ø—Ä–∞–≤–∏–ª–∞ iptables - —Ñ–∞–π–ª [iptables_rules_inetRouter2.ipv4](./vagrant30_2/ansible/templates/iptables_rules_inetRouter2.ipv4))
- –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö –¥–æ—Å—Ç—É–ø –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –æ—Å—Ç–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ inetRouter

```bash 
 # –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞ nginx c —Ö–æ—Å—Ç–æ–≤–æ–π –º–∞—à–∏–Ω—ã
  ‚ï≠‚îÄalex@smith in repo: otuslinuxprof/30-iptables/vagrant30 on Ôêò main [!?] via ‚ç± v2.4.5 took 2m12s
[üî¥] √ó curl 192.168.0.3:8080
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
```

```bash
# –ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ —Å–µ—Ä–≤–µ—Ä—É –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º conntrack
vagrant@inetRouter2:~$ sudo conntrack -E
    [NEW] tcp      6 120 SYN_SENT src=192.168.0.1 dst=192.168.0.3 sport=47442 dport=8080 [UNREPLIED] src=192.168.0.2 dst=192.168.0.3 sport=80 dport=47442
 [UPDATE] tcp      6 60 SYN_RECV src=192.168.0.1 dst=192.168.0.3 sport=47442 dport=8080 src=192.168.0.2 dst=192.168.0.3 sport=80 dport=47442
 [UPDATE] tcp      6 432000 ESTABLISHED src=192.168.0.1 dst=192.168.0.3 sport=47442 dport=8080 src=192.168.0.2 dst=192.168.0.3 sport=80 dport=47442 [ASSURED]
 [UPDATE] tcp      6 120 FIN_WAIT src=192.168.0.1 dst=192.168.0.3 sport=47442 dport=8080 src=192.168.0.2 dst=192.168.0.3 sport=80 dport=47442 [ASSURED]
 [UPDATE] tcp      6 30 LAST_ACK src=192.168.0.1 dst=192.168.0.3 sport=47442 dport=8080 src=192.168.0.2 dst=192.168.0.3 sport=80 dport=47442 [ASSURED]
 [UPDATE] tcp      6 120 TIME_WAIT src=192.168.0.1 dst=192.168.0.3 sport=47442 dport=8080 src=192.168.0.2 dst=192.168.0.3 sport=80 dport=47442 [ASSURED]


```

### Links:

- [https://wiki.archlinux.org/title/Port_knocking](https://wiki.archlinux.org/title/Port_knocking)
- [https://putty.org.ru/articles/port-knocking](https://putty.org.ru/articles/port-knocking)
- [–ï—â–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤ –æ Path MTU Discovery Black Hole](https://habr.com/ru/articles/136871/)
- [–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ª–∏ ICMP —Ç—Ä–∞—Ñ–∏–∫? –í–æ–ø—Ä–æ—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏](https://14bytes.ru/blokirovat-li-icmp-trafik-bezopasno-li/)
--- 
–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ (—Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü–∞ mangle)
- [https://www.linuxtopia.org/Linux_Firewall_iptables/x4368.html](https://www.linuxtopia.org/Linux_Firewall_iptables/x4368.html)
- [https://unix.stackexchange.com/questions/467076/how-set-mark-option-works-on-netfilter-iptables](https://unix.stackexchange.com/questions/467076/how-set-mark-option-works-on-netfilter-iptables)
---
- [–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ iptables –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª](https://habr.com/ru/articles/259169/)