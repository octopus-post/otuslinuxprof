# Less47. SMTP, IMAP, POP3

## MTA, MDA, LDA, MUA
    ● MTA (Mail Transfer Agent) — сервис передачи сообщения
        ○ sendmail/Postfix/qmail/Exim
    ● MDA (Mail Delivery Agent) — сервис получения и доставки сообщения пользователю
        ○ Dovecot
    ● LDA (Local Delivery Agent) — сервис получения и доставки сообщения локальному пользователю
        ○ Postfix/Dovecot
    ● MUA (Mail User Agent) — почтовый клиент
        ○ Thunderbird/Microsoft Outlook

## Базовые SMTP команды
    HELO Команда приветствия от SMTP-клиента
    MAIL Идентифицирует отправителя
    RCPT Идентифицирует получателя
    DATA Указывает на начало сообщения
    SEND Отправляет письмо в терминал
    SOML Send-or-Mail; отправляет письмо в почтовый ящик либо в терминал получателя
    SAML Send-and-Mail; отправляет письмо и в почтовый ящик, и в терминал получателя
    RSET Reset; отменяет соединение и всю переданную информацию
    VRFY Удостоверяется, что такой пользователю есть на сервере
    EXPN Удостоверяется, что такой адрес рассылки есть на сервере
    HELP выводит список команд
    NOOP No operation; нужен для траблшутинга, сервер отвечает OK
    QUIT Заканчивает SMTP-сессию
    TURN Запрос на изменение текущих ролей в SNMP-взаимодействии

### Пример отправки письма
```bash
$ telnet localhost 25
Trying ::1...
Connected to localhost.
Escape character is '^]'.
220 mail.ivan-demo-gb.ru ESMTP Postfix
HELO ivan-demo-gb.ru
250 mail.ivan-demo-gb.ru
MAIL FROM: <ivan@ivan-demo-gb.ru>
250 2.1.0 Ok
RCPT TO: <ivan@ivan-demo-gb.ru>
250 2.1.5 Ok
DATA
354 End data with <CR><LF>.<CR><LF>
test data
.
250 2.0.0 Ok: queued as 8101E1894D03
QUIT
221 2.0.0 Bye
Connection closed by foreign host.
```

## PTR запись
PTR (Pointer record) — запись в DNS, позволяющая получить имя узла
по его IP-адресу.

    ● Подтверждает связь домена с IP-адресом сервера отправителя
    ● Прописывается хостером или провайдером, которому
    принадлежит сеть
    ● Негласное правило: на каждую A запись должна быть PTR

## MX запись
MX запись — запись в DNS, указывающая на сервер, принимающий
почту для домена.

    ● Возвращает A запись почтового сервера для домена (по A записи
    возвращается IP-адрес сервера)
    ● MX записей может быть несколько
    ● Указывает приоритет почтового сервера
    ● A запись, на которую ссылается MX, должна существовать

## SPF
SPF (Sender Policy Framework) — запись, содержащая информацию о серверах, которые могут отправлять почту с вашего домена

    ● Наличие SPF снижает вероятность попадания письма в спам
    ● Может быть только одна SPF запись для одного домена, но в ней могут быть перечислены несколько серверов
### SPF: пример записи
    v=spf1 - версия SPF, обязательный параметр
    ip4: - параметр указывает адрес (несколько адресов, или подсеть)
    a - разрешает отправлять письма с адреса, который указан в A записи домена отправителя mx
    - разрешает отправлять письма c адреса, который указан в MX записи домена
    include - включает в себя хосты, разрешенные SPF-записью указанного домена
    ~all - описывает все остальные сервера, не перечисленные в SPF-записи.
    Параметр ~ означает SoftFail или мягкое отклонение не соответствующих сообщений

## DKIM
DKIM (Domain Keys Identified Mail) — цифровая подпись, подтверждающая подлинность отправителя и целостность доставленного письма

    ● Используется пара ключей шифрования (закрытый — для подписи, открытый — для проверки подписи)
    ● Для получения открытого ключа используется DNS
    ● Подпись автоматически проверяется почтовым серверов в соответствии с заданными политиками

### DKIM: пример записи
    t=s — означает, что запись будет использована только для домена, к которому относится запись, не рекомендуется, если используются субдомены
    o=~ — не особо строгая проверка, означает, что некоторые сообщения с этого домена подписываются DKIM
    o=- — строгая проверка, означает, что все сообщения с этого домена подписываются
    ; — разделитель
    v=DKIM1 — версия, обязательный аргумент, всегда принимает значение DKIM1
    k=rsa — тип используемого ключа
    p= — собственно публичный RSA-ключ

## DMARC
DMARC (Domain-based Message Authentication, Reporting and Conformance) —
это механизм защиты от спама и от несанкционированной рассылки почты с домена

    ● Информирование почтового сервера получателя о наличии записей DKIM, SPF и их использовании
    ● Рекомендации почтовому серверу получателя об обработке почты с невалидными DKIM и SPF
    ● Получение обратной связи от серверов получателей в формате RFC 5969 и RFC 5070, которые позволяют, в частности, узнать о несанкционированной рассылке с домена

## DMARC: пример записи
    v=, версия, обязательный параметр и должен быть первым со значением DMARC1
    p=, policy, значение none — нет рекомендации почтовому серверу
    fo=, fail policy, значение 1 - отправляет обратный ответ, если какая-то из проверок невалидна
    rua=, список почтовых адресов через запятую, на которые высылать агрегированные отчеты
    ruf=, опциональный, список почтовых адресов через запятую, на которые высылать fail- отчеты (о невалидной почте)

## SPAM

#### Причины
    ● боты и ботнеты
    ● открытые почтовые релеи
    ● зомби-сервера
    ● интерфейсы iKVM, iLo и прочие
    ● взломанные аккаунты почтовых систем

#### Отличительные черты
    ● Невалидный обратный адрес
    ● Неправильные заголовки
    ● Хост отправления не является публичным MX
    ● Не повторяют отправку
    ● Тело письма содержит спам

## Протокол POP3
POP3 (Post Office Protocol Version 3) — протокол почтового отделения, версия 3

    ● Порт 110/TCP (без SSL)
    ● Порт 995/TCP (over SSL)
    ● Загружает сообщения с сервера на локальный клиент
    ● Удаляет сообщения с сервера
    ● Работает только в одном направлении (сервер -> клиент)
    ● Аутентификация SASL (англ. Simple Authentication and Security Layer — простой уровень аутентификации и безопасности)
    ● Актуальное описание в RFC — https://tools.ietf.org/html/rfc1939

## Протокол IMAP
IMAP — Internet Message Access Protocol

    ● Порт 143/TCP (без SSL)
    ● Порт 993/TCP (over SSL)
    ● Работает с сообщениями на сервере
    ● Отслеживает состояние сообщений
    ● Дает возможность работать нескольким клиентам с одним почтовым ящиком
    ● Описан в https://tools.ietf.org/html/rfc3501

